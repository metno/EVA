<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutorial &#8212; EVA 2.1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="EVA 2.1.0 documentation" href="index.html" />
    <link rel="next" title="Adapter documentation" href="adapters.html" />
    <link rel="prev" title="Configuration directives" href="variables.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>EVA 2.1.0 documentation</span></a></h1>
        <h2 class="heading"><span>Tutorial</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="variables.html">Configuration directives</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="adapters.html">Adapter documentation</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial will show you how to write an adapter for Event Adapter. You will
be using Python 3 for the logic that needs to go inside EVA. The tutorial
assumes that you have read the <a class="reference internal" href="intro.html"><span class="doc">Introduction to Event Adapter</span></a>, set up your development
environment according to the <a class="reference internal" href="development.html"><span class="doc">Development</span></a> section, and created basic
configuration files as described in <a class="reference internal" href="configuration.html"><span class="doc">Configuration</span></a>.</p>
<p>First, a note on data flow. EVA is data-driven, using a message queue system
for event delivery. This means that every time metadata is updated in
<a class="reference external" href="https://github.com/metno/productstatus">Productstatus</a>, a message is generated, and sent to everyone who is interested.
EVA listens to this message queue, and loads the metadata (<cite>Resource</cite>)
associated with the event from Productstatus. This <cite>Resource</cite> is then passed on
to your Adapter class for validation, and if it is validated, your adapter
should generate a job that will be scheduled to run in a shell on a computing
node.</p>
<div class="section" id="creating-an-adapter">
<h2>Creating an adapter<a class="headerlink" href="#creating-an-adapter" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we are going to create an adapter that computes checksums for
processed files, and stores the result in Productstatus.  Your adapter can live
either inside or outside of the main EVA repository. For simplicity&#8217;s sake, in
this tutorial we create an adapter that lives inside the main repository.</p>
<p>Create a skeleton file in the <code class="docutils literal"><span class="pre">eva/adapters/</span></code> directory:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal"><span class="pre">eva/adapters/checksum.py</span></code></span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">eva.base.adapter</span>

<span class="k">class</span> <span class="nc">ChecksumAdapter</span><span class="p">(</span><span class="n">eva</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">BaseAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">finish_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">generate_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<p>This is the bare minimum required in order to load and run your adapter. The
three functions you need to override are documented here:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="api/baseadapter.html#eva.base.adapter.BaseAdapter.create_job" title="eva.base.adapter.BaseAdapter.create_job"><code class="xref py py-meth docutils literal"><span class="pre">eva.base.adapter.BaseAdapter.create_job()</span></code></a></li>
<li><a class="reference internal" href="api/baseadapter.html#eva.base.adapter.BaseAdapter.finish_job" title="eva.base.adapter.BaseAdapter.finish_job"><code class="xref py py-meth docutils literal"><span class="pre">eva.base.adapter.BaseAdapter.finish_job()</span></code></a></li>
<li><a class="reference internal" href="api/baseadapter.html#eva.base.adapter.BaseAdapter.generate_resources" title="eva.base.adapter.BaseAdapter.generate_resources"><code class="xref py py-meth docutils literal"><span class="pre">eva.base.adapter.BaseAdapter.generate_resources()</span></code></a></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="loading-the-adapter">
<h2>Loading the adapter<a class="headerlink" href="#loading-the-adapter" title="Permalink to this headline">¶</a></h2>
<p>In order to make your adapter run, you&#8217;ll need to create a configuration
section for your adapter instance:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal"><span class="pre">eva-config/checksumadapter.ini</span></code></span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[adapter.test.checksum]</span>
<span class="na">class</span> <span class="o">=</span> <span class="s">eva.adapter.checksum.ChecksumAdapter</span>
</pre></div>
</div>
</div>
<p>Now start EVA, loading the configuration directory (and, thus, your newly
created configuration file). You should see evidence of your adapter being
loaded:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ python -m eva --config /path/to/eva-config/
(INFO) Starting EVA: the EVent Adapter.
...
(INFO) Instantiating &#39;eva.adapter.checksum.ChecksumAdapter&#39; from configuration section &#39;adapter.test.checksum&#39;.
...
(INFO) Initializing &#39;&lt;ChecksumAdapter: adapter.test.checksum&gt;&#39;...
(WARNING) [adapter.test.checksum] Posting to Productstatus is DISABLED due to insufficient configuration.
...
(INFO) Configured adapter: &lt;ChecksumAdapter: adapter.test.checksum&gt;
...
</pre></div>
</div>
<p>The adapter is loaded into the program. Right now, your adapter will accept all
events passed to it, but do nothing. Next, we&#8217;ll take a look at how to make it
do something meaningful.</p>
</div>
<div class="section" id="adding-configuration-variables">
<h2>Adding configuration variables<a class="headerlink" href="#adding-configuration-variables" title="Permalink to this headline">¶</a></h2>
<p>We want our adapter to be re-usable so that we do not have to change the source
code each time we want to change the hashing algorithm. EVA supports custom
configuration variables, which can be configured in the INI files. We define
our configuration variables in the <a class="reference internal" href="api/config.html#eva.config.ConfigurableObject.CONFIG" title="eva.config.ConfigurableObject.CONFIG"><code class="xref py py-attr docutils literal"><span class="pre">eva.config.ConfigurableObject.CONFIG</span></code></a>
dictionary, and mark its inclusion in the INI file as optional:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal"><span class="pre">eva/adapters/checksum.py</span></code></span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ChecksumAdapter</span><span class="p">(</span><span class="n">eva</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">BaseAdapter</span><span class="p">):</span>
    <span class="n">CONFIG</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;md5&#39;</span><span class="p">,</span>
            <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;Hashing algorithm used to create a checksum.&#39;</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="n">OPTIONAL_CONFIG</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;algorithm&#39;</span><span class="p">,</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now, the variable is loaded from the INI file. If omitted, it will fall back on
the default value of <code class="docutils literal"><span class="pre">md5</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal"><span class="pre">eva-config/checksumadapter.ini</span></code></span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[adapter.test.checksum]</span>
<span class="na">class</span> <span class="o">=</span> <span class="s">eva.adapter.checksum.ChecksumAdapter</span>
<span class="na">algorithm</span> <span class="o">=</span> <span class="s">sha256</span>
</pre></div>
</div>
</div>
<p>You can access the variable from within your code, like this:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal"><span class="pre">eva/adapters/checksum.py</span></code></span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ChecksumAdapter</span><span class="p">(</span><span class="n">eva</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">BaseAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sha256&#39;</span>  <span class="c1"># True</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="adding-executable-shell-code">
<h2>Adding executable shell code<a class="headerlink" href="#adding-executable-shell-code" title="Permalink to this headline">¶</a></h2>
<p>Now that we have the configuration option in place, let&#8217;s generate a job that
will be executed on the computing infrastructure. The
<code class="xref py py-meth docutils literal"><span class="pre">eva.base.adapter.create_job()</span></code> method is expected to set the
<code class="xref py py-attr docutils literal"><span class="pre">eva.job.Job.command</span></code> variable to a string that will be put into a shell
script and executed.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal"><span class="pre">eva/adapters/checksum.py</span></code></span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">eva</span>
<span class="kn">import</span> <span class="nn">eva.exceptions</span>

<span class="k">class</span> <span class="nc">ChecksumAdapter</span><span class="p">(</span><span class="n">eva</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">BaseAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">adapter_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sha256&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hash_command</span> <span class="o">=</span> <span class="s2">&quot;sha256sum </span><span class="si">%(path)s</span><span class="s2"> | awk &#39;{print $1}&#39;&quot;</span>
        <span class="k">elif</span> <span class="n">selv</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;md5&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hash_command</span> <span class="o">=</span> <span class="s2">&quot;md5sum </span><span class="si">%(path)s</span><span class="s2"> | awk &#39;{print $1}&#39;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">eva</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidConfigurationException</span><span class="p">(</span>
                <span class="s2">&quot;Hashing algorithm &#39;</span><span class="si">%s</span><span class="s2">&#39; in not supported.&quot;</span> <span class="o">%</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">eva</span><span class="o">.</span><span class="n">url_to_filename</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">job</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s1">&#39;#!/bin/sh&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hash_command</span> <span class="o">%</span> <span class="n">params</span><span class="p">,</span>
        <span class="p">])</span>
</pre></div>
</div>
</div>
<p>Here, we do two things. First, we run a check upon adapter initialization,
verifying that the configuration have parameters that our adapter supports. We
cache the command line we are going to use for later. If the adapter is
mis-configured, it is neccessary to raise
<a class="reference internal" href="api/exceptions.html#eva.exceptions.InvalidConfigurationException" title="eva.exceptions.InvalidConfigurationException"><code class="xref py py-exc docutils literal"><span class="pre">eva.exceptions.InvalidConfigurationException</span></code></a> so that EVA can
complain about it to the user, and then terminate. Second, when a event arrives
on the wire, a <code class="xref py py-class docutils literal"><span class="pre">eva.job.Job</span></code> object is created, containing the
<cite>Resource</cite> metadata in the <code class="xref py py-attr docutils literal"><span class="pre">job.resource</span></code> attribute. We use this
information to retrieve the path of the file that was updated, and create a
shell script that will be executed on a compute node.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">Generated shell script</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
sha256sum /path/to/source/file.nc <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="shell-code-execution">
<h2>Shell code execution<a class="headerlink" href="#shell-code-execution" title="Permalink to this headline">¶</a></h2>
<p>Your adapter is not concerned with the actual execution of the shell code. EVA
will handle this part of the job for you, and execute the
<code class="xref py py-func docutils literal"><span class="pre">eva.base.adapter.finish_job()</span></code> when the job has finished (regardless
whether it failed or not.)</p>
</div>
<div class="section" id="automatically-restarting-jobs">
<h2>Automatically restarting jobs<a class="headerlink" href="#automatically-restarting-jobs" title="Permalink to this headline">¶</a></h2>
<p>EVA supports automatically retrying jobs when they fail. Jobs may fail due to a
excruciating number of reasons, so this is probably something you want. To
enable this functionality, you must raise a
<a class="reference internal" href="api/exceptions.html#eva.exceptions.RetryException" title="eva.exceptions.RetryException"><code class="xref py py-exc docutils literal"><span class="pre">eva.exceptions.RetryException</span></code></a> in the <code class="xref py py-func docutils literal"><span class="pre">finish_job()</span></code> function.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal"><span class="pre">eva/adapters/checksum.py</span></code></span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">eva.exceptions</span>

<span class="k">class</span> <span class="nc">ChecksumAdapter</span><span class="p">(</span><span class="n">eva</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">BaseAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">finish_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">complete</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">eva</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RetryException</span><span class="p">(</span>
                <span class="s2">&quot;This job has to run, at all costs!&quot;</span>
            <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-metadata-to-productstatus">
<h2>Writing metadata to Productstatus<a class="headerlink" href="#writing-metadata-to-productstatus" title="Permalink to this headline">¶</a></h2>
<p>After the <code class="xref py py-func docutils literal"><span class="pre">finish_job()</span></code> function has run, and not generating any
exceptions, EVA will call the <code class="xref py py-func docutils literal"><span class="pre">eva.base.adapter.generate_resources()</span></code>
function. This function may populate the <code class="xref py py-attr docutils literal"><span class="pre">resources</span></code> parameter with
Productstatus resources that should be permanently persisted in the database.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal"><span class="pre">eva/adapters/checksum.py</span></code></span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ChecksumAdapter</span><span class="p">(</span><span class="n">eva</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">BaseAdapter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">generate_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="n">job</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">hash_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span>
        <span class="n">job</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">hash</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">resources</span><span class="p">[</span><span class="s1">&#39;datainstance&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">resource</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>The <code class="xref py py-attr docutils literal"><span class="pre">job.stdout</span></code> attribute contains the standard output from the executed
shell script. We modify the original <code class="xref py py-class docutils literal"><span class="pre">productstatus.api.Resource</span></code> object
with new hash and hash type attributes, and populate the <code class="xref py py-attr docutils literal"><span class="pre">resources</span></code>
parameter to specify that this resource should be saved back to Productstatus.</p>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="variables.html">Configuration directives</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="adapters.html">Adapter documentation</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, MET Norway.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>